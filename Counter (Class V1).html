<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Creeper</title>
</head>

<body>
    <div id="root"></div>

    <script>
        class VirtualDOM {
            static #isRender = false;
            static #root = null;
            static createRoot(root) {
                const rootClass = new VirtualDOM.#Root(root);
                VirtualDOM.#root = rootClass;
                return VirtualDOM.#root;
            }
            static invokeRender() {
                VirtualDOM.#isRender = true;
            }
            static #Root = class {
                #rootElement = null;
                #renderElement = null;
                constructor(rootElement) {
                    this.#rootElement = rootElement;
                }
                render(renderElement) {
                    let isFunction = false;
                    if (typeof renderElement === "function") {
                        isFunction = true;
                    } else {
                        isFunction = false;
                    }
                    const refresh = (bool) => {
                        if (bool) {
                            this.#rootElement.appendChild(renderElement());
                        } else {
                            this.#rootElement.appendChild(renderElement.render());
                        }
                    }
                    refresh(isFunction);
                    FunctionComponent.increaseCurrentIndex();
                    setInterval(() => {
                        if (VirtualDOM.#isRender) {
                            this.#rootElement.innerHTML = "";
                            refresh(isFunction);
                            VirtualDOM.#isRender = false;
                        }
                    }, 1);
                }
            }
        }
        class ClassComponent {
            props = {};
            constructor(props) {
                this.props = props;
            }
            setState = (updatedState) => {
                Object.assign(this.state, updatedState);
                VirtualDOM.invokeRender();
            }
        }
        class FunctionComponent {
            static #currentIndex = 0;
            static #states = [[], []];
            static useState(value) {
                const states = FunctionComponent.#states;
                const currentIndex = FunctionComponent.#currentIndex;
                const index0 = (currentIndex + 1) % 2;
                let index1 = 0;
                if (currentIndex === 0) {
                    states[index0].push(value);
                    index1 = states[index0].length - 1;
                    return [states[index0][index1], FunctionComponent.#getSetStateCallBack(index1)];
                }
                states[index0].push("dummy");
                index1 = states[index0].length - 1;
                states[index0][index1] = states[(index0 + 1) % 2][index1];
                return [states[index0][index1], FunctionComponent.#getSetStateCallBack(index1)];
            }
            static increaseCurrentIndex() {
                FunctionComponent.#currentIndex++;
            }
            static #getSetStateCallBack(index1) {
                const setState = (s) => {
                    FunctionComponent.increaseCurrentIndex();
                    const states = FunctionComponent.#states;
                    const currentIndex = FunctionComponent.#currentIndex;

                    const index0 = (currentIndex + 1) % 2; //original
                    const newIndex0 = (currentIndex) % 2  //new
                    const newState = [...states[index0]];
                    newState[index1] = s;
                    states[newIndex0] = newState;
                    states[index0] = [];

                    VirtualDOM.invokeRender();
                    console.log(states);
                };
                return setState;
            }
        }
        class App extends ClassComponent {
            state = {
                card1Title: "Counter 1",
                card1Content: 0,
                card2Title: "Counter 2",
                card2Content: 0
            }
            props = {};
            constructor(props) {
                super(props);
                this.props = props;
            }
            card1OnIncrementHandler = (num) => {
                this.setState({ card1Content: this.state.card1Content + num });
            }
            card2OnIncrementHandler = (num) => {
                this.setState({ card2Content: this.state.card2Content + num });
            }
            render() {
                let outerDiv = document.createElement("div");
                let section = document.createElement("section");
                let article = document.createElement("article");
                let h1 = document.createElement("h1");
                h1.innerText = "This is a simulation of React VirtualDOM";
                let card1 = new Card({
                    title: this.state.card1Title,
                    content: this.state.card1Content,
                    onIncrement: this.card1OnIncrementHandler,
                    numX: 1
                });
                let card2 = new Card({
                    title: this.state.card2Title,
                    content: this.state.card2Content,
                    onIncrement: this.card2OnIncrementHandler,
                    numX: 2
                });
                article.style.display = "flex";
                article.style.gap = "20px";
                section.appendChild(h1);
                article.appendChild(card1.render());
                article.appendChild(card2.render());
                outerDiv.appendChild(section);
                outerDiv.appendChild(article);
                return outerDiv;
            }
        }
        class Card extends ClassComponent {
            state = {};
            props = {};
            constructor(props) {
                super(props);
                this.props = props;
            }
            clickHandler = (e) => {
                this.props.onIncrement(this.props.numX);
            }
            render() {
                let div = document.createElement("div");
                let title = document.createElement("h2");
                let content = document.createElement("p");
                let button = document.createElement("button");
                div.style.border = "3px solid blue";
                div.style.width = "fit-content";
                div.style.display = "flex";
                div.style.flexDirection = "column";
                button.addEventListener("click", this.clickHandler);
                title.innerText = this.props.title;
                content.innerText = this.props.content;
                content.style.textAlign = "center";
                button.innerText = "Click";
                div.appendChild(title);
                div.appendChild(content);
                div.appendChild(button);
                return div;
            }
        }
        window.onload = () => {
            const container = document.getElementById('root');
            const root = VirtualDOM.createRoot(container);
            root.render(new App());
        }
    </script>
</body>

</html>